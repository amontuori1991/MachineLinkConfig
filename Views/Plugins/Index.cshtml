@model List<MachineLinkConfig.Models.Plugin>

@{
    ViewData["Title"] = "Plugins";
}

<div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <h2 style="margin:0;">Plugins</h2>
    <div style="display:flex; gap:8px;">
        <a class="btn btn-primary" href="/plugins/create">+ Crea Plugin</a>
        <a class="btn btn-dark" href="/plugins/import">Importa da testo</a>
    </div>
</div>

<hr />

@if (!Model.Any())
{
    <p>Nessun plugin ancora presente.</p>
}
else
{
    <table class="table table-striped align-middle" id="pluginsTable">
        <thead>
            <tr>
                <th>Display</th>
                <th>Name</th>
                <th class="text-center">SURVEYS</th>
                <th class="text-center">MACHINEREADER</th>
                <th class="text-center">AUTOSTORE</th>
                <th class="text-center">Dispatcher</th>
                <th class="text-center">Dispatcher Code</th>
            </tr>

            <!-- RIGA FILTRI -->
            <tr>
                <th>
                    <input class="form-control form-control-sm"
                           type="text"
                           placeholder="Cerca..."
                           data-filter="text"
                           data-col="display" />
                </th>

                <th>
                    <input class="form-control form-control-sm"
                           type="text"
                           placeholder="Cerca..."
                           data-filter="text"
                           data-col="name" />
                </th>

                <th class="text-center">
                    <select class="form-select form-select-sm"
                            data-filter="bool"
                            data-col="surveys">
                        <option value="">Tutti</option>
                        <option value="SI">SI</option>
                        <option value="NO">NO</option>
                    </select>
                </th>

                <th class="text-center">
                    <select class="form-select form-select-sm"
                            data-filter="bool"
                            data-col="machinereader">
                        <option value="">Tutti</option>
                        <option value="SI">SI</option>
                        <option value="NO">NO</option>
                    </select>
                </th>

                <th class="text-center">
                    <select class="form-select form-select-sm"
                            data-filter="bool"
                            data-col="autostore">
                        <option value="">Tutti</option>
                        <option value="SI">SI</option>
                        <option value="NO">NO</option>
                    </select>
                </th>

                <th class="text-center">
                    <select class="form-select form-select-sm"
                            data-filter="bool"
                            data-col="dispatcher">
                        <option value="">Tutti</option>
                        <option value="SI">SI</option>
                        <option value="NO">NO</option>
                    </select>
                </th>

                <th class="text-center">
                    <input class="form-control form-control-sm"
                           type="text"
                           placeholder="Cerca..."
                           data-filter="text"
                           data-col="dispatchercode" />
                </th>
            </tr>
        </thead>

        <tbody>
            @foreach (var p in Model)
            {
                var dispCode = string.IsNullOrWhiteSpace(p.DispatcherCode) ? "-" : p.DispatcherCode;

                <tr data-display="@p.DisplayName"
                    data-name="@p.Name"
                    data-surveys="@(p.SupportsSurveys ? "SI" : "NO")"
                    data-machinereader="@(p.SupportsMachineReader ? "SI" : "NO")"
                    data-autostore="@(p.SupportsAutoStoreReader ? "SI" : "NO")"
                    data-dispatcher="@(p.ManagesDispatcher ? "SI" : "NO")"
                    data-dispatchercode="@dispCode">
                    <td>
                        <a href="/plugins/@p.Id">@p.DisplayName</a>
                    </td>

                    <td><code>@p.Name</code></td>

                    <td class="text-center @(p.SupportsSurveys ? "text-success fw-bold" : "text-danger")">
                        @(p.SupportsSurveys ? "SI" : "NO")
                    </td>

                    <td class="text-center @(p.SupportsMachineReader ? "text-success fw-bold" : "text-danger")">
                        @(p.SupportsMachineReader ? "SI" : "NO")
                    </td>

                    <td class="text-center @(p.SupportsAutoStoreReader ? "text-success fw-bold" : "text-danger")">
                        @(p.SupportsAutoStoreReader ? "SI" : "NO")
                    </td>

                    <td class="text-center @(p.ManagesDispatcher ? "text-success fw-bold" : "text-danger")">
                        @(p.ManagesDispatcher ? "SI" : "NO")
                    </td>

                    <td class="text-center">
                        @dispCode
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <script>
        (function () {
            const table = document.getElementById("pluginsTable");
            if (!table) return;

            const filters = Array.from(table.querySelectorAll("thead [data-filter]"));
            const rows = Array.from(table.querySelectorAll("tbody tr"));

            function norm(s) {
                return (s || "").toString().trim().toLowerCase();
            }

            function applyFilters() {
                // costruisco un dizionario: col -> value
                const active = {};
                for (const f of filters) {
                    const col = f.getAttribute("data-col");
                    const val = norm(f.value);
                    active[col] = val; // "" = nessun filtro
                }

                for (const r of rows) {
                    let ok = true;

                    // text columns (contains)
                    const display = norm(r.dataset.display);
                    const name = norm(r.dataset.name);
                    const dispatchercode = norm(r.dataset.dispatchercode);

                    if (active.display && !display.includes(active.display)) ok = false;
                    if (ok && active.name && !name.includes(active.name)) ok = false;
                    if (ok && active.dispatchercode && !dispatchercode.includes(active.dispatchercode)) ok = false;

                    // boolean columns (exact match SI/NO)
                    if (ok && active.surveys && norm(r.dataset.surveys) !== active.surveys) ok = false;
                    if (ok && active.machinereader && norm(r.dataset.machinereader) !== active.machinereader) ok = false;
                    if (ok && active.autostore && norm(r.dataset.autostore) !== active.autostore) ok = false;
                    if (ok && active.dispatcher && norm(r.dataset.dispatcher) !== active.dispatcher) ok = false;

                    r.style.display = ok ? "" : "none";
                }
            }

            // live filter: input + change
            for (const f of filters) {
                f.addEventListener("input", applyFilters);
                f.addEventListener("change", applyFilters);
            }

            // primo apply (non necessario ma pulito)
            applyFilters();
        })();
    </script>
}
