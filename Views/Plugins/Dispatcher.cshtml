@model MachineLinkConfig.Controllers.DispatcherPageVm

@{
    ViewData["Title"] = "Dispatcher";
    int i = 0;
}

<div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <div>
        <h2 style="margin:0;">Dispatcher</h2>
        <div class="text-muted">
            Plugin: <b>@Model.PluginName</b> — Dispatcher Code: <code>@Model.DispatcherCode</code>
        </div>
    </div>
    <div style="display:flex; gap:10px;">
        <a class="btn btn-secondary" href="/plugins/@Model.PluginId">← Dettaglio</a>
        <a class="btn btn-warning" href="/plugins/@Model.PluginId/dispatcher/templates/create">+ Template Dispatcher</a>
    </div>
</div>

<hr />

@if (!Model.Templates.Any())
{
    <p>Nessun template Dispatcher. Aggiungi IP / PORT / PROGRAM_ADDRESS ecc.</p>
}
else
{
    <form method="post" action="/plugins/@Model.PluginId/dispatcher/save">
        @Html.AntiForgeryToken()

        @foreach (var m in Model.Machines)
        {
            <div style="padding:12px; border:1px solid #ddd; border-radius:8px; margin-bottom:14px;">
                <h5 style="margin:0;">Configurazione @m.MachineNo.ToString("D2")</h5>

                <table class="table table-sm table-striped" style="margin-top:10px;">
                    <thead>
                        <tr>
                            <th>Parametro</th>
                            <th>Descrizione</th>
                            <th>Company (CFUSR)</th>
                            <th>Valore (CFVAL)</th>
                            <th>Export</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var r in m.Rows)
                        {
                            <tr>
                                <td><code>@r.ParamCode</code></td>
                                <td>@r.Description</td>
                                <td style="width:160px;">
                                    <input class="form-control form-control-sm" name="Items[@i].CompanyCode" value="@r.CompanyCode" />
                                </td>
                                <td>
                                    <input class="form-control form-control-sm" name="Items[@i].Value" value="@r.Value" />
                                </td>
                                <td style="width:90px; text-align:center;">
                                    <input type="checkbox" name="Items[@i].ExportEnabled" value="true" @(r.ExportEnabled ? "checked" : "") />
                                    <input type="hidden" name="Items[@i].ExportEnabled" value="false" />
                                </td>

                                <input type="hidden" name="Items[@i].ValueId" value="@r.ValueId" />
                                <input type="hidden" name="Items[@i].MachineConfigId" value="@r.MachineConfigId" />
                                <input type="hidden" name="Items[@i].TemplateId" value="@r.TemplateId" />
                            </tr>
                            i++;
                        }
                    </tbody>
                </table>
            </div>
        }

        <button class="btn btn-primary" type="submit">Salva Dispatcher</button>
    </form>
}
